<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pylon Partners Treasury</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fragment+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:rgb(10,10,14);--bg2:rgb(18,18,24);--bg3:rgb(26,26,34);
  --fg:rgb(230,230,235);--fg2:rgb(160,160,170);--fg3:rgb(100,100,112);
  --accent:rgb(99,102,241);--accent2:rgb(129,140,248);
  --green:rgb(34,197,94);--red:rgb(239,68,68);
  --border:rgba(255,255,255,0.08);
  --card-bg:var(--bg2);--card-border:var(--border);
  --radius:12px;--radius-sm:8px;
  --shadow:0 1px 3px rgba(0,0,0,0.3),0 1px 2px rgba(0,0,0,0.2);
}
[data-theme="light"]{
  --bg:rgb(248,248,252);--bg2:rgb(255,255,255);--bg3:rgb(240,240,245);
  --fg:rgb(20,20,28);--fg2:rgb(80,80,92);--fg3:rgb(140,140,155);
  --border:rgba(0,0,0,0.08);
  --shadow:0 1px 3px rgba(0,0,0,0.08),0 1px 2px rgba(0,0,0,0.04);
}
html{font-size:16px}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--fg);line-height:1.6;min-height:100vh;display:flex;flex-direction:column}
h1,h2,h3,h4,h5,h6,.mono{font-family:'Fragment Mono',monospace}
a{color:var(--accent2);text-decoration:none}
a:hover{text-decoration:underline}

.container{max-width:1120px;margin:0 auto;padding:0 1.5rem;width:100%}
header{padding:1.5rem 0;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
header .logo{display:flex;flex-direction:column;gap:0.25rem}
header h1{font-size:1.1rem;font-weight:700;letter-spacing:-0.02em}
header .sub{font-size:0.8rem;color:var(--fg2);font-family:'Inter',sans-serif}
.theme-toggle{background:var(--bg3);border:1px solid var(--border);color:var(--fg2);padding:0.4rem 0.75rem;border-radius:var(--radius-sm);cursor:pointer;font-size:0.8rem;font-family:'Fragment Mono',monospace;transition:all 0.2s}
.theme-toggle:hover{color:var(--fg);border-color:var(--fg3)}

.hero{text-align:center;padding:3rem 0 2rem}
.hero h2{font-size:2rem;font-weight:700;letter-spacing:-0.03em;margin-bottom:0.5rem}
.hero p{color:var(--fg2);font-size:1rem;max-width:520px;margin:0 auto}

.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:2rem}
.stat-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);padding:1.25rem;text-align:center;box-shadow:var(--shadow)}
.stat-card .label{font-size:0.75rem;color:var(--fg3);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.25rem}
.stat-card .value{font-family:'Fragment Mono',monospace;font-size:1.5rem;font-weight:700}
.stat-card .value.loading{color:var(--fg3);font-size:1rem}

.wallets{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:1rem;margin-bottom:2rem}
.wallet-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);padding:1.5rem;box-shadow:var(--shadow)}
.wallet-card .card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:1px solid var(--border)}
.wallet-card .wallet-name{font-family:'Fragment Mono',monospace;font-size:1rem;font-weight:700}
.wallet-card .wallet-addr{font-size:0.75rem;color:var(--fg3);font-family:'Fragment Mono',monospace}
.wallet-card .wallet-total{font-family:'Fragment Mono',monospace;font-size:1.1rem;font-weight:700;color:var(--green);text-align:right}

.chain-section{margin-bottom:0.75rem}
.chain-label{font-size:0.7rem;color:var(--fg3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:0.35rem;display:flex;align-items:center;gap:0.4rem}
.chain-dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.chain-dot.ethereum{background:#627eea}
.chain-dot.base{background:#0052ff}
.chain-dot.arbitrum{background:#28a0f0}
.holdings{display:flex;flex-direction:column;gap:0.35rem}
.holding-row{display:flex;justify-content:space-between;align-items:center;padding-left:1.2rem}
.holding-row .token{display:flex;align-items:center;gap:0.5rem}
.holding-row .token-symbol{font-family:'Fragment Mono',monospace;font-size:0.85rem;font-weight:600}
.holding-row .token-bal{font-size:0.8rem;color:var(--fg2)}
.holding-row .usd{font-family:'Fragment Mono',monospace;font-size:0.85rem;color:var(--fg2)}

.breakdown{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);padding:1.5rem;margin-bottom:2rem;box-shadow:var(--shadow)}
.breakdown h3{font-size:1rem;margin-bottom:1rem}
.bar-chart{display:flex;flex-direction:column;gap:0.5rem}
.bar-row{display:flex;align-items:center;gap:0.75rem}
.bar-label{font-family:'Fragment Mono',monospace;font-size:0.8rem;width:60px;flex-shrink:0}
.bar-track{flex:1;height:24px;background:var(--bg3);border-radius:4px;overflow:hidden;position:relative}
.bar-fill{height:100%;border-radius:4px;transition:width 0.6s ease}
.bar-fill.eth{background:linear-gradient(90deg,#627eea,#8b9df7)}
.bar-fill.usdc{background:linear-gradient(90deg,#2775ca,#4a9ae8)}
.bar-fill.usdt{background:linear-gradient(90deg,#26a17b,#50c4a1)}
.bar-fill.dai{background:linear-gradient(90deg,#f5ac37,#f7c96e)}
.bar-fill.usdbc{background:linear-gradient(90deg,#1e5ed9,#4a82e8)}
.bar-pct{font-family:'Fragment Mono',monospace;font-size:0.75rem;color:var(--fg3);width:50px;text-align:right;flex-shrink:0}

footer{margin-top:auto;padding:1.5rem 0;border-top:1px solid var(--border);text-align:center}
footer p{font-size:0.8rem;color:var(--fg3)}
.last-updated{font-size:0.75rem;color:var(--fg3);text-align:center;margin-bottom:1.5rem;font-family:'Fragment Mono',monospace}

@media(max-width:640px){
  .stats{grid-template-columns:repeat(2,1fr)}
  .wallets{grid-template-columns:1fr}
  .hero h2{font-size:1.5rem}
  .stat-card .value{font-size:1.2rem}
}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--fg3);border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite;vertical-align:middle}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo">
      <h1>Pylon Partners</h1>
      <span class="sub">Treasury Dashboard</span>
    </div>
    <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">light</button>
  </header>

  <section class="hero">
    <h2>Pylon Partners Treasury</h2>
    <p>Real-time overview of on-chain treasury holdings across Ethereum, Base &amp; Arbitrum</p>
  </section>

  <section class="stats" id="stats">
    <div class="stat-card"><div class="label">Total Portfolio Value</div><div class="value loading" id="totalValue"><span class="spinner"></span></div></div>
    <div class="stat-card"><div class="label">ETH Price</div><div class="value loading" id="ethPrice"><span class="spinner"></span></div></div>
    <div class="stat-card"><div class="label">Chains</div><div class="value">3</div></div>
    <div class="stat-card"><div class="label">Wallets</div><div class="value">3</div></div>
  </section>

  <section class="wallets" id="wallets"></section>

  <section class="breakdown" id="breakdown">
    <h3>Portfolio Breakdown</h3>
    <div class="bar-chart" id="barChart"></div>
  </section>

  <div class="last-updated" id="lastUpdated">Loading...</div>
</div>

<footer><div class="container"><p>A Pylon Partners project</p></div></footer>

<script>
const WALLETS = [
  { name: 'Cash In', addr: '0x179a5B6aEa4E669c75d8820641741BCd99C8f36F' },
  { name: 'Treasury', addr: '0x608405a3575b69fa2e05Ff3b9f012D16eE2d0985' },
  { name: 'Khala Cash In', addr: '0xcB23A5F76fFa21Dc5c6c502edaa22eF275F0c9Fa' }
];

const CHAINS = [
  { id: 'ethereum', label: 'Ethereum', api: 'https://eth.blockscout.com', explorer: 'https://etherscan.io' },
  { id: 'base', label: 'Base', api: 'https://base.blockscout.com', explorer: 'https://basescan.org' },
  { id: 'arbitrum', label: 'Arbitrum', api: 'https://arbitrum.blockscout.com', explorer: 'https://arbiscan.io' }
];

// Known tokens per chain: address (lowercase) -> { symbol, decimals }
const KNOWN_TOKENS = {
  ethereum: {
    '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48': { symbol: 'USDC', decimals: 6 },
    '0xdac17f958d2ee523a2206206994597c13d831ec7': { symbol: 'USDT', decimals: 6 },
    '0x6b175474e89094c44da98b954eedeac495271d0f': { symbol: 'DAI', decimals: 18 }
  },
  base: {
    '0x833589fcd6edb6e08f4c7c32d4f71b54bda02913': { symbol: 'USDC', decimals: 6 },
    '0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca': { symbol: 'USDbC', decimals: 6 }
  },
  arbitrum: {
    '0xaf88d065e77c8cc2239327c5edb3a432268e5831': { symbol: 'USDC', decimals: 6 },
    '0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9': { symbol: 'USDT', decimals: 6 }
  }
};

function toggleTheme() {
  const html = document.documentElement;
  const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  document.getElementById('themeBtn').textContent = next === 'dark' ? 'light' : 'dark';
}
(function initTheme() {
  const saved = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', saved);
  document.getElementById('themeBtn').textContent = saved === 'dark' ? 'light' : 'dark';
})();

function fmt(n, decimals = 2) {
  return n.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
}
function truncAddr(a) { return a.slice(0, 6) + '...' + a.slice(-4); }

async function fetchJSON(url, timeoutMs = 10000) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeoutMs);
  try {
    const r = await fetch(url, { signal: ctrl.signal });
    if (!r.ok) throw new Error(r.status);
    return await r.json();
  } finally { clearTimeout(t); }
}

async function getEthPrice() {
  const base = 'https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd';
  try { const d = await fetchJSON(base, 8000); return d.ethereum.usd; } catch {}
  try { const d = await fetchJSON('https://corsproxy.io/?' + encodeURIComponent(base), 8000); return d.ethereum.usd; } catch {}
  try { const d = await fetchJSON('https://api.allorigins.win/get?url=' + encodeURIComponent(base), 8000); return JSON.parse(d.contents).ethereum.usd; } catch {}
  return null;
}

async function getChainData(chain, addr) {
  const result = { ethBal: 0, tokens: [] };
  try {
    const [info, tokens] = await Promise.all([
      fetchJSON(`${chain.api}/api/v2/addresses/${addr}`, 12000),
      fetchJSON(`${chain.api}/api/v2/addresses/${addr}/token-balances`, 12000)
    ]);
    result.ethBal = parseFloat(info.coin_balance || '0') / 1e18;
    const STABLE_SYMBOLS = new Set(['USDC', 'USDT', 'DAI', 'USDbC']);
    for (const t of tokens) {
      const sym = t.token?.symbol || '';
      const dec = parseInt(t.token?.decimals || '18');
      if (STABLE_SYMBOLS.has(sym)) {
        const raw = parseFloat(t.value || '0');
        const bal = raw / Math.pow(10, dec);
        if (bal > 0.01) {
          result.tokens.push({ symbol: sym, balance: bal });
        }
      }
    }
  } catch (e) {
    console.warn(`Failed ${chain.id}/${truncAddr(addr)}:`, e.message);
  }
  return result;
}

function renderWallets(walletData, ethP) {
  const container = document.getElementById('wallets');
  container.innerHTML = '';
  let totalPortfolio = 0;
  const globalTotals = {};

  for (const w of walletData) {
    let walletTotal = 0;
    const card = document.createElement('div');
    card.className = 'wallet-card';
    let chainsHTML = '';

    for (const cd of w.chains) {
      const chain = cd.chain;
      const data = cd.data;
      const holdings = [];
      if (data.ethBal > 0.0001) {
        const usd = data.ethBal * ethP;
        holdings.push({ sym: 'ETH', bal: fmt(data.ethBal, 4), usd });
        walletTotal += usd;
        globalTotals['ETH'] = (globalTotals['ETH'] || 0) + usd;
      }
      for (const tk of data.tokens) {
        holdings.push({ sym: tk.symbol, bal: fmt(tk.balance, 2), usd: tk.balance });
        walletTotal += tk.balance;
        globalTotals[tk.symbol] = (globalTotals[tk.symbol] || 0) + tk.balance;
      }
      if (holdings.length > 0) {
        chainsHTML += `<div class="chain-section">
          <div class="chain-label"><span class="chain-dot ${chain.id}"></span>${chain.label}</div>
          <div class="holdings">${holdings.map(h => `
            <div class="holding-row">
              <div class="token"><span class="token-symbol">${h.sym}</span><span class="token-bal">${h.bal}</span></div>
              <span class="usd">$${fmt(h.usd)}</span>
            </div>`).join('')}
          </div>
        </div>`;
      }
    }

    totalPortfolio += walletTotal;
    card.innerHTML = `
      <div class="card-header">
        <div>
          <div class="wallet-name">${w.name}</div>
          <span class="wallet-addr">${truncAddr(w.addr)}</span>
        </div>
        <div class="wallet-total">$${fmt(walletTotal)}</div>
      </div>
      ${chainsHTML || '<div style="color:var(--fg3);font-size:0.85rem">No balances found</div>'}
    `;
    container.appendChild(card);
  }

  document.getElementById('totalValue').textContent = '$' + fmt(totalPortfolio);
  document.getElementById('ethPrice').textContent = '$' + fmt(ethP);

  // Breakdown bars
  const chart = document.getElementById('barChart');
  chart.innerHTML = '';
  const barClasses = { ETH: 'eth', USDC: 'usdc', USDT: 'usdt', DAI: 'dai', USDbC: 'usdbc' };
  const sorted = Object.entries(globalTotals).sort((a, b) => b[1] - a[1]);
  for (const [sym, val] of sorted) {
    const pct = totalPortfolio > 0 ? (val / totalPortfolio * 100) : 0;
    const row = document.createElement('div');
    row.className = 'bar-row';
    row.innerHTML = `
      <span class="bar-label">${sym}</span>
      <div class="bar-track"><div class="bar-fill ${barClasses[sym] || 'usdc'}" style="width:${pct}%"></div></div>
      <span class="bar-pct">${fmt(pct, 1)}%</span>
    `;
    chart.appendChild(row);
  }
}

async function refresh() {
  try {
    const ethPPromise = getEthPrice();
    const walletPromises = WALLETS.map(async w => {
      const chains = await Promise.all(CHAINS.map(async chain => ({
        chain,
        data: await getChainData(chain, w.addr)
      })));
      return { ...w, chains };
    });
    const [ethP, ...walletResults] = await Promise.all([ethPPromise, ...walletPromises]);
    if (!ethP) { document.getElementById('lastUpdated').textContent = 'Failed to fetch ETH price'; return; }
    renderWallets(walletResults, ethP);
    document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleString();
  } catch (e) {
    console.error('Refresh error:', e);
    document.getElementById('lastUpdated').textContent = 'Error refreshing data - retrying...';
  }
}

refresh();
setInterval(refresh, 60000);
</script>
</body>
</html>
